#!/usr/bin/env bash
#
# è‡ªåŠ¨æ›´æ–° CHANGELOG
# åœ¨ commit åå°† commit message è¿½åŠ åˆ° CHANGELOG.md å¹¶ amend
#

# é˜²æ­¢é€’å½’è°ƒç”¨
if [ -n "$SKIP_POST_COMMIT" ]; then
    exit 0
fi

CHANGELOG_FILE="CHANGELOG.md"
COMMIT_MSG=$(git log -1 --pretty=%B)

# è·³è¿‡ merge commit
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|remote-tracking branch)"; then
    exit 0
fi

# è·³è¿‡ç©ºçš„ commit message
if [ -z "$COMMIT_MSG" ]; then
    exit 0
fi

# è§£æ commit message (åªå–ç¬¬ä¸€è¡Œ)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
TYPE=$(echo "$FIRST_LINE" | sed -E 's/^([a-z]+)(\(.+\))?: .*/\1/')
SCOPE=$(echo "$FIRST_LINE" | sed -nE 's/^[a-z]+\((.+)\): .*/\1/p')
DESCRIPTION=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+(\(.+\))?: (.*)/\2/')

# å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ç±»å‹ï¼Œè¯´æ˜æ ¼å¼ä¸å¯¹ï¼Œè·³è¿‡
if [ "$TYPE" = "$FIRST_LINE" ]; then
    exit 0
fi

# è·å–å½“å‰æ—¥æœŸ
DATE=$(date +%Y-%m-%d)

# åˆ›å»º CHANGELOG.md å¦‚æœä¸å­˜åœ¨
if [ ! -f "$CHANGELOG_FILE" ]; then
    cat > "$CHANGELOG_FILE" << EOF
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

EOF
fi

# å‡†å¤‡æ’å…¥çš„å†…å®¹
SCOPE_TEXT=""
if [ -n "$SCOPE" ]; then
    SCOPE_TEXT="**[$SCOPE]**"
fi

# æ ¹æ®ç±»å‹é€‰æ‹©å¯¹åº”çš„ç« èŠ‚æ ‡é¢˜
case "$TYPE" in
    feat)
        SECTION="### âœ¨ Features"
        ;;
    fix)
        SECTION="### ğŸ› Bug Fixes"
        ;;
    docs)
        SECTION="### ğŸ“ Documentation"
        ;;
    style)
        SECTION="### ğŸ’„ Styles"
        ;;
    refactor)
        SECTION="### â™»ï¸ Code Refactoring"
        ;;
    perf)
        SECTION="### âš¡ Performance"
        ;;
    test)
        SECTION="### âœ… Tests"
        ;;
    build)
        SECTION="### ğŸ“¦ Build"
        ;;
    ci)
        SECTION="### ğŸ‘· CI"
        ;;
    chore)
        SECTION="### ğŸ”§ Chore"
        ;;
    revert)
        SECTION="### âª Reverts"
        ;;
    *)
        SECTION="### ğŸ”€ Other"
        ;;
esac

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶
TEMP_FILE=$(mktemp)

# æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šå¤©çš„æ—¥æœŸæ ‡é¢˜
if grep -q "## \[$DATE\]" "$CHANGELOG_FILE"; then
    # å·²å­˜åœ¨ä»Šå¤©çš„æ—¥æœŸï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ section
    awk -v date="$DATE" -v section="$SECTION" -v scope="$SCOPE_TEXT" -v desc="$DESCRIPTION" '
    BEGIN { in_date = 0; in_section = 0; section_found = 0; inserted = 0 }

    # åŒ¹é…ä»Šå¤©çš„æ—¥æœŸæ ‡é¢˜
    /^## \['"$DATE"'\]/ { in_date = 1; print; next }

    # å¦‚æœåœ¨ä»Šå¤©çš„æ—¥æœŸå†…
    in_date == 1 {
        # é‡åˆ°æ–°çš„æ—¥æœŸæ ‡é¢˜ï¼Œé€€å‡ºä»Šå¤©çš„æ—¥æœŸ
        if (/^## \[/) { in_date = 0; }

        # åŒ¹é…å¯¹åº”çš„ section
        if ($0 == section) {
            in_section = 1
            section_found = 1
            print
            next
        }

        # å¦‚æœåœ¨å¯¹åº”çš„ section å†…ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ¡ç›®å‰æ’å…¥
        if (in_section == 1 && /^- /) {
            if (inserted == 0) {
                print "-" (scope != "" ? " " scope : "") " " desc
                inserted = 1
            }
        }

        # é‡åˆ°æ–°çš„ sectionï¼Œé€€å‡ºå½“å‰ section
        if (in_section == 1 && /^### /) {
            if (inserted == 0) {
                print "-" (scope != "" ? " " scope : "") " " desc
                inserted = 1
            }
            in_section = 0
        }
    }

    # æ‰“å°æ‰€æœ‰å…¶ä»–è¡Œ
    { print }

    END {
        # å¦‚æœæ‰¾åˆ°äº† section ä½†æ²¡æœ‰æ¡ç›®ï¼Œæˆ–è€…æ²¡æ‰¾åˆ° section
        if (in_date == 1 && section_found == 0) {
            # éœ€è¦åœ¨æ–‡ä»¶æœ«å°¾å¤„ç†çš„æƒ…å†µ
        }
    }
    ' "$CHANGELOG_FILE" > "$TEMP_FILE"

    # å¦‚æœå¯¹åº”çš„ section ä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ 
    if ! grep -A 1000 "## \[$DATE\]" "$TEMP_FILE" | grep -q "^$SECTION"; then
        # æ‰¾åˆ°ä»Šå¤©æ—¥æœŸçš„ä½ç½®ï¼Œåœ¨å…¶åæ·»åŠ æ–° section
        awk -v date="$DATE" -v section="$SECTION" -v scope="$SCOPE_TEXT" -v desc="$DESCRIPTION" '
        /^## \['"$DATE"'\]/ {
            print
            getline
            print section
            print "-" (scope != "" ? " " scope : "") " " desc
            print ""
            print
            next
        }
        { print }
        ' "$TEMP_FILE" > "${TEMP_FILE}.2"
        mv "${TEMP_FILE}.2" "$TEMP_FILE"
    fi
else
    # ä¸å­˜åœ¨ä»Šå¤©çš„æ—¥æœŸï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ’å…¥æ–°çš„æ—¥æœŸå’Œ section
    awk -v date="$DATE" -v section="$SECTION" -v scope="$SCOPE_TEXT" -v desc="$DESCRIPTION" '
    BEGIN { inserted = 0 }

    # åœ¨ç¬¬ä¸€ä¸ªæ—¥æœŸæ ‡é¢˜å‰æ’å…¥
    /^## \[/ && inserted == 0 {
        print "## [" date "]"
        print ""
        print section
        print "-" (scope != "" ? " " scope : "") " " desc
        print ""
        inserted = 1
    }

    # å¦‚æœæ²¡æœ‰æ—¥æœŸæ ‡é¢˜ï¼Œåœ¨ changelog å¤´éƒ¨ä¹‹åæ’å…¥
    /^The format is based on/ && inserted == 0 {
        print
        getline
        print
        print "## [" date "]"
        print ""
        print section
        print "-" (scope != "" ? " " scope : "") " " desc
        print ""
        inserted = 1
        next
    }

    { print }
    ' "$CHANGELOG_FILE" > "$TEMP_FILE"
fi

# æ›¿æ¢åŸæ–‡ä»¶
mv "$TEMP_FILE" "$CHANGELOG_FILE"

# å°† CHANGELOG.md æ·»åŠ åˆ°æš‚å­˜åŒºå¹¶ amend commit
git add "$CHANGELOG_FILE"
SKIP_POST_COMMIT=1 git commit --amend --no-edit --no-verify

exit 0
