#!/usr/bin/env bash
#
# è‡ªåŠ¨æ›´æ–° CHANGELOG
# åœ¨ commit å‰å°† commit message è¿½åŠ åˆ° CHANGELOG.md
#

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# åªåœ¨æ­£å¸¸ commit æ—¶æ›´æ–° CHANGELOG
if [ "$COMMIT_SOURCE" = "message" ] || [ "$COMMIT_SOURCE" = "template" ] || [ "$COMMIT_SOURCE" = "merge" ]; then
    exit 0
fi

CHANGELOG_FILE="CHANGELOG.md"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# è·³è¿‡ merge commit
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|remote-tracking branch)"; then
    exit 0
fi

# è·³è¿‡ç©ºçš„ commit message
if [ -z "$COMMIT_MSG" ]; then
    exit 0
fi

# è§£æž commit message
TYPE=$(echo "$COMMIT_MSG" | sed -E 's/^([a-z]+)(\(.+\))?: .*/\1/')
SCOPE=$(echo "$COMMIT_MSG" | sed -nE 's/^[a-z]+\((.+)\): .*/\1/p')
DESCRIPTION=$(echo "$COMMIT_MSG" | sed -E 's/^[a-z]+(\(.+\))?: (.*)/\2/')

# å¦‚æžœæ²¡æœ‰åŒ¹é…åˆ°ç±»åž‹ï¼Œè¯´æ˜Žæ ¼å¼ä¸å¯¹ï¼Œè·³è¿‡
if [ "$TYPE" = "$COMMIT_MSG" ]; then
    exit 0
fi

# èŽ·å–å½“å‰æ—¥æœŸ
DATE=$(date +%Y-%m-%d)

# åˆ›å»º CHANGELOG.md å¦‚æžœä¸å­˜åœ¨
if [ ! -f "$CHANGELOG_FILE" ]; then
    cat > "$CHANGELOG_FILE" << EOF
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

EOF
fi

# å‡†å¤‡æ’å…¥çš„å†…å®¹
SCOPE_TEXT=""
if [ -n "$SCOPE" ]; then
    SCOPE_TEXT=" **[$SCOPE]**"
fi

# æ ¹æ®ç±»åž‹é€‰æ‹©å¯¹åº”çš„ç« èŠ‚æ ‡é¢˜
case "$TYPE" in
    feat)
        SECTION="### âœ¨ Features"
        ;;
    fix)
        SECTION="### ðŸ› Bug Fixes"
        ;;
    docs)
        SECTION="### ðŸ“ Documentation"
        ;;
    style)
        SECTION="### ðŸ’„ Styles"
        ;;
    refactor)
        SECTION="### â™»ï¸ Code Refactoring"
        ;;
    perf)
        SECTION="### âš¡ Performance"
        ;;
    test)
        SECTION="### âœ… Tests"
        ;;
    build)
        SECTION="### ðŸ“¦ Build"
        ;;
    ci)
        SECTION="### ðŸ‘· CI"
        ;;
    chore)
        SECTION="### ðŸ”§ Chore"
        ;;
    revert)
        SECTION="### âª Reverts"
        ;;
    *)
        SECTION="### ðŸ”€ Other"
        ;;
esac

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶
TEMP_FILE=$(mktemp)

# æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šå¤©çš„æ—¥æœŸæ ‡é¢˜
if grep -q "## \[$DATE\]" "$CHANGELOG_FILE"; then
    # å·²å­˜åœ¨ä»Šå¤©çš„æ—¥æœŸï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ section
    awk -v date="$DATE" -v section="$SECTION" -v scope="$SCOPE_TEXT" -v desc="$DESCRIPTION" '
    BEGIN { in_date = 0; in_section = 0; section_found = 0; inserted = 0 }

    # åŒ¹é…ä»Šå¤©çš„æ—¥æœŸæ ‡é¢˜
    /^## \['"$DATE"'\]/ { in_date = 1; print; next }

    # å¦‚æžœåœ¨ä»Šå¤©çš„æ—¥æœŸå†…
    in_date == 1 {
        # é‡åˆ°æ–°çš„æ—¥æœŸæ ‡é¢˜ï¼Œé€€å‡ºä»Šå¤©çš„æ—¥æœŸ
        if (/^## \[/) { in_date = 0; }

        # åŒ¹é…å¯¹åº”çš„ section
        if ($0 == section) {
            in_section = 1
            section_found = 1
            print
            next
        }

        # å¦‚æžœåœ¨å¯¹åº”çš„ section å†…ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ¡ç›®å‰æ’å…¥
        if (in_section == 1 && /^- /) {
            if (inserted == 0) {
                print "- " scope " " desc
                inserted = 1
            }
        }

        # é‡åˆ°æ–°çš„ sectionï¼Œé€€å‡ºå½“å‰ section
        if (in_section == 1 && /^### /) {
            if (inserted == 0) {
                print "- " scope " " desc
                inserted = 1
            }
            in_section = 0
        }
    }

    # æ‰“å°æ‰€æœ‰å…¶ä»–è¡Œ
    { print }

    END {
        # å¦‚æžœæ‰¾åˆ°äº† section ä½†æ²¡æœ‰æ¡ç›®ï¼Œæˆ–è€…æ²¡æ‰¾åˆ° section
        if (in_date == 1 && section_found == 0) {
            # éœ€è¦åœ¨æ–‡ä»¶æœ«å°¾å¤„ç†çš„æƒ…å†µ
        }
    }
    ' "$CHANGELOG_FILE" > "$TEMP_FILE"

    # å¦‚æžœå¯¹åº”çš„ section ä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ 
    if ! grep -A 1000 "## \[$DATE\]" "$TEMP_FILE" | grep -q "^$SECTION"; then
        # æ‰¾åˆ°ä»Šå¤©æ—¥æœŸçš„ä½ç½®ï¼Œåœ¨å…¶åŽæ·»åŠ æ–° section
        awk -v date="$DATE" -v section="$SECTION" -v scope="$SCOPE_TEXT" -v desc="$DESCRIPTION" '
        /^## \['"$DATE"'\]/ {
            print
            getline
            print section
            print "- " scope " " desc
            print ""
            print
            next
        }
        { print }
        ' "$TEMP_FILE" > "${TEMP_FILE}.2"
        mv "${TEMP_FILE}.2" "$TEMP_FILE"
    fi
else
    # ä¸å­˜åœ¨ä»Šå¤©çš„æ—¥æœŸï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ’å…¥æ–°çš„æ—¥æœŸå’Œ section
    awk -v date="$DATE" -v section="$SECTION" -v scope="$SCOPE_TEXT" -v desc="$DESCRIPTION" '
    BEGIN { inserted = 0 }

    # åœ¨ç¬¬ä¸€ä¸ªæ—¥æœŸæ ‡é¢˜å‰æ’å…¥
    /^## \[/ && inserted == 0 {
        print "## [" date "]"
        print ""
        print section
        print "- " scope " " desc
        print ""
        inserted = 1
    }

    # å¦‚æžœæ²¡æœ‰æ—¥æœŸæ ‡é¢˜ï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ’å…¥
    /^# Changelog/ {
        print
        getline
        print
        getline
        print
        print "## [" date "]"
        print ""
        print section
        print "- " scope " " desc
        print ""
        inserted = 1
        next
    }

    { print }
    ' "$CHANGELOG_FILE" > "$TEMP_FILE"
fi

# æ›¿æ¢åŽŸæ–‡ä»¶
mv "$TEMP_FILE" "$CHANGELOG_FILE"

# å°† CHANGELOG.md æ·»åŠ åˆ°æš‚å­˜åŒº
git add "$CHANGELOG_FILE" 2>/dev/null || true

exit 0
