#!/usr/bin/env bash
#
# Git commit message 格式检查 hook
# 要求格式: <type>: <description>
# 支持的 type: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
#

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 允许的 commit 类型
ALLOWED_TYPES="feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert"

# commit message 格式正则
PATTERN="^(${ALLOWED_TYPES})(\(.+\))?: .{1,}"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 跳过 merge commit
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|remote-tracking branch)"; then
    exit 0
fi

# 跳过 revert commit
if echo "$COMMIT_MSG" | grep -qE "^Revert \".*\""; then
    exit 0
fi

# 检查格式
if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo -e "${RED}Commit message 格式错误!${NC}"
    echo ""
    echo -e "${YELLOW}当前 commit message:${NC}"
    echo "  $COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}正确格式:${NC}"
    echo "  <type>: <description>"
    echo "  或"
    echo "  <type>(scope): <description>"
    echo ""
    echo -e "${YELLOW}支持的类型:${NC}"
    echo "  feat     - 新功能"
    echo "  fix      - 修复 bug"
    echo "  docs     - 文档变更"
    echo "  style    - 代码格式(不影响代码运行的变动)"
    echo "  refactor - 重构(既不是新功能也不是修复bug)"
    echo "  test     - 增加测试"
    echo "  chore    - 构建过程或辅助工具的变动"
    echo "  perf     - 性能优化"
    echo "  ci       - CI 配置文件和脚本的变动"
    echo "  build    - 影响构建系统或外部依赖的变更"
    echo "  revert   - 回退之前的 commit"
    echo ""
    echo -e "${YELLOW}示例:${NC}"
    echo "  feat: 添加用户登录功能"
    echo "  fix: 修复登录按钮点击无响应问题"
    echo "  feat(auth): 添加 JWT 认证支持"
    echo "  docs(readme): 更新安装说明"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ Commit message 格式正确${NC}"
exit 0
