# ChatRoom Nginx - 便携式配置

worker_processes auto;

pid logs/nginx.pid;

error_log logs/error.log warn;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # 基础 MIME 类型
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    types_hash_bucket_size 128;

    # 临时目录
    client_body_temp_path temp/client_body;
    proxy_temp_path temp/proxy;
    fastcgi_temp_path temp/fastcgi;
    uwsgi_temp_path temp/uwsgi;
    scgi_temp_path temp/scgi;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct=$upstream_connect_time urt=$upstream_response_time';
    access_log logs/access.log main;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # 超时设置
    keepalive_timeout 65;
    client_header_timeout 15s;
    client_body_timeout 15s;
    send_timeout 15s;

    # 缓冲区设置
    client_body_buffer_size 16k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript
               text/xml application/xml application/xml+rss text/javascript;

    # Gateway 上游服务器集群，选择最小连接算法
    upstream gateway_cluster {
        least_conn;

        # TODO: 增加更多 Gateway 实例
        server 127.0.0.1:10001 weight=1 max_fails=3 fail_timeout=30s;

        # 保持长连接，设置最大空闲连接数
        keepalive 64;
    }

    server {
        listen 9000;
        server_name localhost;

        # 安全头部
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # 健康检查端点
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }

        # 所有请求转发到 Gateway
        location / {
            proxy_pass http://gateway_cluster;

            # 代理头部 - 传递真实客户端信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # HTTP/1.1 保持长连接
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # 代理超时
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            # 代理缓冲
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 24k;
        }
    }
}
